{% extends "base.html" %} 
{% load static %}

{% block css_block %}
  <link rel="stylesheet" href="{% static 'css/star.css' %}">
  <link rel="stylesheet" href="{% static 'css/scroll.css' %}">
{% endblock css_block %}

{% block content %}
    <div id='titleContainer' class="d-flex flex-column align-items-center"></div>
    <div class="container">
        <div id='infoDiv'>
            <span id='starScoreSpan'></span>
            <span id='makerNameSpan'></span>
            <span id='createdAtSpan'></span>
        </div>
        <div id='infoDiv2'>
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#exampleModal">★★★★★</button>
        </div>
    </div>
    <br>
    <div class="container">
        <div id='containerDiv' class='d-flex flex-column align-items-center justify-content-center'>
            <div id='wrap-vertical' class="scroll-container"></div>
            <br>
            <div id="carouselExampleIndicators" class="carousel slide">
                <div id='carouselContent' class="carousel-inner" style="position: relative; width: 960px; padding-bottom: 56.25%;"></div>
            </div>
        </div>
        <div id='contentDiv' class=''></div>
    </div>
    <br>
    <div class="container">
      <form id='formElement' method='POST' onsubmit="CommentCreate(event);">
        {% csrf_token %}
        <label for="comment">댓글</label>
        <input type="text" id='comment' name='content'>
        <button type="submit">제출</button>
      </form>
      <div id='commentContainerDiv'></div>
    </div>
    <br>

<!-- Modal -->
<div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="exampleModalLabel">별점 선택창</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        별점을 선택해주세요
        <form name="myform" id="myform" method="POST">
          <fieldset class='d-flex justify-content-center'>
              <input type="radio" name="star" value="5" id="rate1"><label for="rate1">⭐</label>
              <input type="radio" name="star" value="4" id="rate2"><label for="rate2">⭐</label>
              <input type="radio" name="star" value="3" id="rate3"><label for="rate3">⭐</label>
              <input type="radio" name="star" value="2" id="rate4"><label for="rate4">⭐</label>
              <input type="radio" name="star" value="1" id="rate5"><label for="rate5">⭐</label>
          </fieldset>
      </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">나가기</button>
        <button type="submit" class="btn btn-primary" onclick='Star(event);'>확인</button>
      </div>
    </div>
  </div>
</div>
<script>
  async function CommentCreate(event) {
    event.preventDefault();  // 폼의 기본 제출 동작을 방지

    const form_tag = document.getElementById('formElement');
    const formData = new FormData(form_tag);

    const url = '{% url 'games:comments' game_pk %}'

    try {
        await aSend({
            url: url,
            method: 'POST',
            is_token: true,
            body: formData
        })
        
    } catch (error) {
        console.error('Error:', error);
        return false;
    }
    window.location.href = "{% url 'games:game_test_page' game_pk %}";
}

async function ReplyCreate(event, root_id) {
  event.preventDefault();  // 폼의 기본 제출 동작을 방지

  const replyForm=event.target;
  const formData = new FormData(replyForm);
  formData.append('root', root_id);
  const content = formData.get('content');
  if (!content) {
      alert("댓글 내용을 입력하세요.");
      return;
  }
  const url = '{% url 'games:comments' game_pk %}'

  try {
      await aSend({
          url: url,
          method: 'POST',
          is_token: true,
          body: formData
      })
      
  } catch (error) {
      console.error('Error:', error);
      return false;
  }
  window.location.href = "{% url 'games:game_test_page' game_pk %}";
}

async function Star(event) {
  event.preventDefault();  // 폼의 기본 제출 동작을 방지

  const form_tag = document.getElementById('myform');
  const formData = new FormData(form_tag);

  const url = '{% url 'games:game_star' game_pk %}'

  try {
      await aSend({
          url: url,
          method: 'POST',
          is_token: true,
          body: formData
      })
      
  } catch (error) {
      console.error('Error:', error);
      return false;
  }
  window.location.href = "{% url 'games:game_test_page' game_pk %}";
}

  window.addEventListener("load", async function PageLoad() {

    // context로 views.py에서 game_pk를 받아서 사용한다.
    const game_detail_URL = '{% url 'games:game_detail' game_pk %}';
    const comment_URL = '{% url 'games:comments' game_pk %}';

    const game_detail_response = await aSend({
      url: game_detail_URL,
      method: 'GET',
      is_token: false,
    });
    
    const comment_response = await aSend({
      url: comment_URL,
      method: 'GET',
      is_token: false,
    });

    const title = game_detail_response.title;
    const gamepath = game_detail_response.gamepath;
    const star_score = game_detail_response.star_score;
    const maker_name = game_detail_response.maker_name;
    const created_at = game_detail_response.created_at;
    const tag = game_detail_response.tag;
    const screenshot = game_detail_response.screenshot;
    const content = game_detail_response.content;
    const youtube_url = game_detail_response.youtube_url;
    // # 1 ==============title과 iframe=====================
    // const titleContainer = document.createElement('div');
    // titleContainer.className = 'd-flex flex-column align-items-center';
    const titleContainer = document.getElementById('titleContainer');

    const divElement = document.createElement('div');
    divElement.style.position = 'relative';
    divElement.style.width = '53%';
    divElement.style.paddingBottom = '36%';

    const titleElement = document.createElement('h1');
    titleElement.textContent = title;
    
    const iframeElement = document.createElement('iframe');
    iframeElement.style.cssText = 'position: absolute; width: 100%; height: 100%;'
    iframeElement.src = `${gamepath}/index.html`;
    
    // document.body.appendChild(titleContainer);

    titleContainer.appendChild(titleElement);
    titleContainer.appendChild(divElement);
    divElement.appendChild(iframeElement);

    // # 2 ================게임 상세 span==================
    const infoDiv = document.getElementById('infoDiv');

    const starScoreSpan = document.getElementById('starScoreSpan');
    if (star_score == null) {
      starScoreSpan.textContent = `평점: 평점없음`;
    }
    else{
      starScoreSpan.textContent = `평점: ${star_score}`;
    }

    const makerNameSpan = document.getElementById('makerNameSpan');
    makerNameSpan.textContent = `제작자: ${maker_name}`;

    const createdAtSpan = document.getElementById('createdAtSpan');
    createdAtSpan.textContent = `업로드 일시: ${created_at}`;

    infoDiv.appendChild(starScoreSpan)
    infoDiv.appendChild(makerNameSpan)
    infoDiv.appendChild(createdAtSpan)

    // # 2-1 ==============게임 상세 span2===================
    const infoDiv2 = document.getElementById('infoDiv2')

    const tagSpan = document.createElement('span');
    tagSpan.textContent = '태그: ';

    tag.forEach((item, index) => {
      const tagItemSpan = document.createElement('span');
      if (index > 0) {
        tagItemSpan.textContent = `, ${item.name}`;
      } else {
        tagItemSpan.textContent = item.name;
      }
      tagSpan.appendChild(tagItemSpan);
    })

    infoDiv2.appendChild(tagSpan)

    // # 3 ==================video와 screenshot=====================
    // const containerDiv = document.createElement('div');
    // containerDiv.className = 'd-flex align-items-center justify-content-around'
    const carouselButtonDiv = document.getElementById('wrap-vertical');
    const carouselContentDiv = document.getElementById('carouselContent');
    let content_idx = 0

    if (youtube_url) {
      const youtube_button = document.createElement('button')
      youtube_button.setAttribute('type','button')
      youtube_button.setAttribute('data-bs-target','#carouselExampleIndicators')
      youtube_button.setAttribute('data-bs-slide-to',`${content_idx}`)
      youtube_button.setAttribute('class','active')
      youtube_button.setAttribute('aria-current','true')
      youtube_button.setAttribute('aria-label',`Slide ${content_idx + 1}`)
      youtube_button.setAttribute('style','vertical-align:middle; width:300px; height:150px;')

      const youtube_thumbnail = document.createElement('img')
      const youtube_id = youtube_url.split('/')[3].replace('watch?v=','').split('?')[0].split('&')[0]
      const youtube_thumbnail_src = 'https://img.youtube.com/vi/' + youtube_id + '/0.jpg'
      // console.log(youtube_thumbnail_src)
      youtube_thumbnail.setAttribute('src', youtube_thumbnail_src)
      youtube_thumbnail.setAttribute('class','d-block w-100')
      youtube_thumbnail.setAttribute('alt','...')

      youtube_button.appendChild(youtube_thumbnail)
      carouselButtonDiv.appendChild(youtube_button)

      const youtube_div = document.createElement('div')
      youtube_div.setAttribute('class','carousel-item active')
      youtube_div.setAttribute('style','position: absolute; max-width: 100%; height: 100%')

      const youtube_iframe = document.createElement('iframe')
      const youtube_src = 'https://www.youtube.com/embed/' + youtube_id
      console.log(youtube_src)
      youtube_iframe.setAttribute('style','position: absolute; width: 100%; height: 100%')
      youtube_iframe.setAttribute('src',youtube_src)
      youtube_iframe.setAttribute('title','YouTube video player')
      youtube_iframe.setAttribute('frameborder','0')
      youtube_iframe.setAttribute('allow','accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share')
      youtube_iframe.setAttribute('referrerpolicy','strict-origin-when-cross-origin')
      youtube_iframe.setAttribute('allowfullscreen','true')

      youtube_div.appendChild(youtube_iframe)
      carouselContentDiv.appendChild(youtube_div)
      content_idx += 1
    }

    for (item of screenshot) {
      const screenshot_button = document.createElement('button')
      if (content_idx == 0) {
        screenshot_button.setAttribute('class','active')
        screenshot_button.setAttribute('aria-current','true')
      }
      screenshot_button.setAttribute('type','button')
      screenshot_button.setAttribute('data-bs-target','#carouselExampleIndicators')
      screenshot_button.setAttribute('data-bs-slide-to',`${content_idx}`)
      screenshot_button.setAttribute('aria-label',`Slide ${content_idx + 1}`)
      screenshot_button.setAttribute('style',"vertical-align:middle; width:300px; height:150px;")

      const screenshot_button_img = document.createElement('img')
      screenshot_button_img.setAttribute('src',item.src)
      screenshot_button_img.setAttribute('class','d-block w-100')
      screenshot_button_img.setAttribute('alt','...')

      screenshot_button.appendChild(screenshot_button_img)
      carouselButtonDiv.appendChild(screenshot_button)

      const screenshot_div = document.createElement('div')
      if (content_idx == 0) {
        screenshot_div.setAttribute('class','carousel-item active')
      } else {
        screenshot_div.setAttribute('class','carousel-item')
      }
      screenshot_div.setAttribute('style','position: absolute; width: 100%; height: 100%')

      const screenshot_img = document.createElement('img')
      screenshot_img.setAttribute('style','object-fit: contain; object-position: center center;')
      screenshot_img.setAttribute('src',item.src)
      screenshot_img.setAttribute('class','d-block w-100')
      screenshot_img.setAttribute('alt','...')

      screenshot_div.appendChild(screenshot_img)
      carouselContentDiv.appendChild(screenshot_div)
      content_idx += 1
    }

    // # 6 =====================게시글에 달린 댓글========================
    const commentContainerDiv = document.getElementById('commentContainerDiv');
    comment_response.forEach(comment => {
        const commentDiv = document.createElement('div');
        commentDiv.setAttribute('data-comment-id',comment.id)
        commentDiv.setAttribute("class", "d-flex justify-content-between");
      
        const userDiv = document.createElement('div');
        const subjectDiv = document.createElement('div');
        subjectDiv.setAttribute("class", "d-flex justify-content-between")
          
        const contentDiv = document.createElement('div');
        const dateDiv = document.createElement('div');
          
        commentDiv.appendChild(userDiv);
        commentDiv.appendChild(subjectDiv);
        subjectDiv.appendChild(contentDiv);
        subjectDiv.appendChild(dateDiv);
        
        const commentImgElement = document.createElement('img');
        if (comment.src) {
            commentImgElement.src = comment.src;
        }
        else {
            commentImgElement.src = '{% static 'image/user.png' %}'
            commentImgElement.style.width = '30px';
        }
        commentImgElement.alt = '';
        userDiv.appendChild(commentImgElement);

        const authorSpanElement = document.createElement('span');
        authorSpanElement.textContent = `${comment.author_name}`;
        userDiv.appendChild(authorSpanElement);

        const contentSpanElement = document.createElement('span');
        contentSpanElement.textContent = `${comment.content}`;
        contentDiv.appendChild(contentSpanElement);

        const commendCreatedAtSpan = document.createElement('span');
        commendCreatedAtSpan.textContent = `${comment.created_at}`;
        dateDiv.appendChild(commendCreatedAtSpan);

        const replyButton=document.createElement('button');
        replyButton.textContent ="댓글 달기";
        replyButton.onclick=function(){
            let existReplyForm=commentDiv.querySelector('.replyForm');
            if(existReplyForm) {
                existReplyForm.remove();
            } 
            else {
                const replyForm=document.createElement('form');
                replyForm.className = 'replyForm';
                replyForm.onsubmit=function(e){ReplyCreate(e,comment.id);};
      
                const replyInput=document.createElement('input');
                replyInput.type = 'text';
                replyInput.name = 'content';
                replyInput.placeholder = '답글을 입력하세요';
              
                const replySubmitButton = document.createElement('button');
                replySubmitButton.type = 'submit';
                replySubmitButton.textContent = '제출';
      
                replyForm.appendChild(replyInput);
                replyForm.appendChild(replySubmitButton);
      
                commentDiv.appendChild(replyForm);
            }
        };
        commentDiv.appendChild(replyButton);

        if (comment.replies && comment.replies.length > 0) {
            const replyContainer = document.createElement('div');
            replyContainer.classList.add('replies');
            comment.replies.forEach(reply => {
                
                const replyDiv = document.createElement('div');
                replyDiv.classList.add('comment');
                const indentSymbol = document.createElement('span');
                indentSymbol.textContent = '↳'; // 원하는 기호로 변경 가능
                
                indentSymbol.style.marginRight = '10px';
                replyDiv.appendChild(indentSymbol);
                const replyImgElement = document.createElement('img');
                if (reply.src) {
                    replyImgElement.src = reply.src;
                } else {
                    replyImgElement.src = '{% static 'image/user.png' %}';
                    replyImgElement.style.width = '30px';
                }
                replyImgElement.alt = '';
                replyDiv.appendChild(replyImgElement);
    
                const replyAuthorSpanElement = document.createElement('span');
                replyAuthorSpanElement.textContent = `작성자: ${reply.author_name}`;
                replyDiv.appendChild(replyAuthorSpanElement);
    
                const replyContentSpanElement = document.createElement('span');
                replyContentSpanElement.textContent = `댓글 내용: ${reply.content}`;
                replyDiv.appendChild(replyContentSpanElement);
    
                const replyCreatedAtSpan = document.createElement('span');
                replyCreatedAtSpan.textContent = `작성 일시: ${reply.created_at}`;
                replyDiv.appendChild(replyCreatedAtSpan);
    
                replyContainer.appendChild(replyDiv);
            });
            commentDiv.appendChild(replyContainer);
        }
        const commentLineBreak = document.createElement('hr');
        commentContainerDiv.appendChild(commentLineBreak);
        commentContainerDiv.appendChild(commentDiv)
    });
});
</script>
{% endblock content %}
