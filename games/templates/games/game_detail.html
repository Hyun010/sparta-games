{% extends "base.html" %} 
{% load static %}

{% block css_block %}
  <link rel="stylesheet" href="{% static 'css/star.css' %}">
  <link rel="stylesheet" href="{% static 'css/scroll.css' %}">
{% endblock css_block %}

{% block content %}

<div id='titleContainer' class="d-flex flex-column align-items-center"></div>
<div id='infoDiv'>
  <span id='starScoreSpan'></span>
  <span id='makerNameSpan'></span>
  <span id='createdAtSpan'></span>
</div>
<div id='infoDiv2'>
  <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#exampleModal">★★★★★</button>

</div>

<div id='containerDiv' class='d-flex flex-column align-items-center justify-content-center'>
  <div id='wrap-vertical' class="scroll-container">
    <button type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide-to="0" class="active" aria-current="true" aria-label="Slide 1" style="vertical-align:middle; width:300px; height:150px;">
      <img style="max-width:200px; max-height:140px" src="https://img.youtube.com/vi/_2MtnLyBdbk/0.jpg" class="d-block w-100" alt="...">
    </button>
    <button type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide-to="1" aria-label="Slide 2" style="vertical-align:middle; width:300px; height:150px;">
      <img style="max-width:200px; max-height:140px" src="https://mblogthumb-phinf.pstatic.net/MjAxNzA4MTVfMTE4/MDAxNTAyNzkzOTcxMjUy.0e3fCnpQEymKTLcZXXQmq0WftRMoIlgCbkCAY6aPwWkg.wsnoG3A6-zxhmKKVkPF3QHuAQ1K4PE0W0SrIJLLK0X4g.JPEG.jaehun12067/img9.jpg?type=w800" class="d-block w-100" alt="...">
    </button>
    <button type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide-to="2" aria-label="Slide 3" style="vertical-align:middle; width:300px; height:150px;">
      <img style="max-width:200px; max-height:140px" src="https://mblogthumb-phinf.pstatic.net/MjAxNzA4MTVfMTE5/MDAxNTAyNzk0MDYzNjMx.XhxajUwM6CJ9qbS4eqN1IophAn7e7WAzWkNUgS_cIpYg.5bsCNVwguqrzRS9hImzaM4gw9usqYk5LW6fcREEPPbcg.JPEG.jaehun12067/img0.jpg?type=w800" class="d-block w-100" alt="...">
    </button>
    <button type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide-to="3" aria-label="Slide 4" style="vertical-align:middle; width:300px; height:150px;">
      <img style="max-width:200px; max-height:140px" src="https://mblogthumb-phinf.pstatic.net/MjAxNzA4MTVfMTE4/MDAxNTAyNzk0MTMwMTk1.hgNNaoSIRkDtRSxTJsY4lfy58XtDNU01sqKWNcIB4kkg.IcSUEeKQxLBvriBxBp4S2rVhJNqjqIlp83oK1lma8cAg.JPEG.jaehun12067/img100.jpg?type=w800" class="d-block w-100" alt="...">
    </button>
    <button type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide-to="4" aria-label="Slide 5" style="vertical-align:middle; width:300px; height:150px;">
      <img style="max-width:200px; max-height:140px" src="https://mspoweruser.com/wp-content/uploads/2022/10/7c2f345bdfcadb8a3faf483ebaa2e9aea712bbdb-scaled.jpg" class="d-block w-100" alt="...">
    </button>
    <button type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide-to="5" aria-label="Slide 6" style="vertical-align:middle; width:300px; height:150px;">
      <img style="max-width:200px; max-height:140px" src="https://storage2.ilyo.co.kr/contents/article/images/2017/1204/1512355898117995.jpg" class="d-block w-100" alt="...">
    </button>
    <button type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide-to="6" aria-label="Slide 7" style="vertical-align:middle; width:300px; height:150px;">
      <img style="max-width:200px; max-height:140px" src="https://mblogthumb-phinf.pstatic.net/MjAxOTA0MjNfMTQ2/MDAxNTU2MDA5MDk3MDg4.bGDd1y6KuI4poMhxJzUctITxhDe4o4m6H1weB3uDRNYg.-BTPc33YdRCuzWIZNZen_NCy4HwZQGCxEPFdKHK9n84g.JPEG.lucomsfam/SE-a2d9748e-7033-442b-b10c-549ebf83aad5.jpg?type=w800" class="d-block w-100" alt="...">
    </button>
    <button type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide-to="7" aria-label="Slide 8" style="vertical-align:middle; width:300px; height:150px;">
      <img style="max-width:200px; max-height:140px" src="https://www.itworld.co.kr/files/itworld/ITW_202301_01/m12-Windows8dot1logo.jpg" class="d-block w-100" alt="...">
    </button>
  </div>
  <br>
  <div id="carouselExampleIndicators" class="carousel slide">
    <div class="carousel-inner" style="position: relative; width: 960px; padding-bottom: 56.25%;">
      <div class="carousel-item active" style="position: absolute; max-width: 100%; height: 100%">
          <iframe style="position: absolute; width: 100%; height: 100%" src="https://www.youtube.com/embed/_2MtnLyBdbk" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>
      </div>
      <div class="carousel-item" style="position: absolute; width: 100%; height: 100%">
        <img style="object-fit: contain; object-position: center center;" src="https://mblogthumb-phinf.pstatic.net/MjAxNzA4MTVfMTE4/MDAxNTAyNzkzOTcxMjUy.0e3fCnpQEymKTLcZXXQmq0WftRMoIlgCbkCAY6aPwWkg.wsnoG3A6-zxhmKKVkPF3QHuAQ1K4PE0W0SrIJLLK0X4g.JPEG.jaehun12067/img9.jpg?type=w800" class="d-block w-100" alt="...">
      </div>
      <div class="carousel-item" style="position: absolute; width: 100%; height: 100%">
        <img style="object-fit: contain; object-position: center center;" src="https://mblogthumb-phinf.pstatic.net/MjAxNzA4MTVfMTE5/MDAxNTAyNzk0MDYzNjMx.XhxajUwM6CJ9qbS4eqN1IophAn7e7WAzWkNUgS_cIpYg.5bsCNVwguqrzRS9hImzaM4gw9usqYk5LW6fcREEPPbcg.JPEG.jaehun12067/img0.jpg?type=w800" class="d-block w-100" alt="...">
      </div>
      <div class="carousel-item" style="position: absolute; width: 100%; height: 100%">
        <img style="object-fit: contain; object-position: center center;" src="https://mblogthumb-phinf.pstatic.net/MjAxNzA4MTVfMTE4/MDAxNTAyNzk0MTMwMTk1.hgNNaoSIRkDtRSxTJsY4lfy58XtDNU01sqKWNcIB4kkg.IcSUEeKQxLBvriBxBp4S2rVhJNqjqIlp83oK1lma8cAg.JPEG.jaehun12067/img100.jpg?type=w800" class="d-block w-100" alt="...">
      </div>
      <div class="carousel-item" style="position: absolute; width: 100%; height: 100%">
        <img style="object-fit: contain; object-position: center center;" src="https://mspoweruser.com/wp-content/uploads/2022/10/7c2f345bdfcadb8a3faf483ebaa2e9aea712bbdb-scaled.jpg" class="d-block w-100" alt="...">
      </div>
      <div class="carousel-item" style="position: absolute; width: 100%; height: 100%">
        <img style="object-fit: contain; object-position: center center;" src="https://storage2.ilyo.co.kr/contents/article/images/2017/1204/1512355898117995.jpg" class="d-block w-100" alt="...">
      </div>
      <div class="carousel-item" style="position: absolute; width: 100%; height: 100%">
        <img style="object-fit: contain; object-position: center center;" src="https://mblogthumb-phinf.pstatic.net/MjAxOTA0MjNfMTQ2/MDAxNTU2MDA5MDk3MDg4.bGDd1y6KuI4poMhxJzUctITxhDe4o4m6H1weB3uDRNYg.-BTPc33YdRCuzWIZNZen_NCy4HwZQGCxEPFdKHK9n84g.JPEG.lucomsfam/SE-a2d9748e-7033-442b-b10c-549ebf83aad5.jpg?type=w800" class="d-block w-100" alt="...">
      </div>
      <div class="carousel-item" style="position: absolute; width: 100%; height: 100%">
        <img style="object-fit: contain; object-position: center center;" src="https://www.itworld.co.kr/files/itworld/ITW_202301_01/m12-Windows8dot1logo.jpg" class="d-block w-100" alt="...">
      </div>
    </div>
  </div>
</div>
<div id='contentDiv' class=''></div>

<div>
  <form id='formElement' method='POST' onsubmit="CommentCreate(event);">
    {% csrf_token %}
    <label for="comment">댓글</label>
    <input type="text" id='comment' name='content'>
    <button type="submit">제출</button>
  </form>
  <div id='commentContainerDiv'></div>
</div>

<!-- Modal -->
<div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="exampleModalLabel">별점 선택창</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        별점을 선택해주세요
        <form name="myform" id="myform" method="POST">
          <fieldset class='d-flex justify-content-center'>
              <input type="radio" name="star" value="5" id="rate1"><label for="rate1">⭐</label>
              <input type="radio" name="star" value="4" id="rate2"><label for="rate2">⭐</label>
              <input type="radio" name="star" value="3" id="rate3"><label for="rate3">⭐</label>
              <input type="radio" name="star" value="2" id="rate4"><label for="rate4">⭐</label>
              <input type="radio" name="star" value="1" id="rate5"><label for="rate5">⭐</label>
          </fieldset>
      </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">나가기</button>
        <button type="submit" class="btn btn-primary" onclick='Star(event);'>확인</button>
      </div>
    </div>
  </div>
</div>
<script>
  async function CommentCreate(event) {
    event.preventDefault();  // 폼의 기본 제출 동작을 방지

    const form_tag = document.getElementById('formElement');
    const formData = new FormData(form_tag);

    const url = '{% url 'games:comments' game_pk %}'

    try {
        await aSend({
            url: url,
            method: 'POST',
            is_token: true,
            body: formData
        })
        
    } catch (error) {
        console.error('Error:', error);
        return false;
    }
    window.location.href = "{% url 'games:game_test_page' game_pk %}";
}
async function Star(event) {
  event.preventDefault();  // 폼의 기본 제출 동작을 방지

  const form_tag = document.getElementById('myform');
  const formData = new FormData(form_tag);

  const url = '{% url 'games:game_star' game_pk %}'

  try {
      await aSend({
          url: url,
          method: 'POST',
          is_token: true,
          body: formData
      })
      
  } catch (error) {
      console.error('Error:', error);
      return false;
  }
  window.location.href = "{% url 'games:game_test_page' game_pk %}";
}
  window.addEventListener("load", async function PageLoad() {

    // context로 views.py에서 game_pk를 받아서 사용한다.
    const game_detail_URL = '{% url 'games:game_detail' game_pk %}';
    const comment_URL = '{% url 'games:comments' game_pk %}';

    const game_detail_response = await aSend({
      url: game_detail_URL,
      method: 'GET',
      is_token: false,
    });
    
    const comment_response = await aSend({
      url: comment_URL,
      method: 'GET',
      is_token: false,
    });

    const title = game_detail_response.title;
    const gamepath = game_detail_response.gamepath;
    const star_score = game_detail_response.star_score;
    const maker_name = game_detail_response.maker_name;
    const created_at = game_detail_response.created_at;
    const tag = game_detail_response.tag;
    const screenshot = game_detail_response.screenshot;
    const content = game_detail_response.content;
    
    // # 1 ==============title과 iframe=====================
    // const titleContainer = document.createElement('div');
    // titleContainer.className = 'd-flex flex-column align-items-center';
    const titleContainer = document.getElementById('titleContainer');

    const divElement = document.createElement('div');
    divElement.style.position = 'relative';
    divElement.style.width = '53%';
    divElement.style.paddingBottom = '36%';

    const titleElement = document.createElement('h1');
    titleElement.textContent = title;
    
    const iframeElement = document.createElement('iframe');
    iframeElement.style.cssText = 'position: absolute; width: 100%; height: 100%;'
    iframeElement.src = `${gamepath}/index.html`;
    
    // document.body.appendChild(titleContainer);

    titleContainer.appendChild(titleElement);
    titleContainer.appendChild(divElement);
    divElement.appendChild(iframeElement);

    // # 2 ================게임 상세 span==================
    const infoDiv = document.getElementById('infoDiv');

    const starScoreSpan = document.getElementById('starScoreSpan');
    starScoreSpan.textContent = `평점: ${star_score}`;

    const makerNameSpan = document.getElementById('makerNameSpan');
    makerNameSpan.textContent = `제작자: ${maker_name}`;

    const createdAtSpan = document.getElementById('createdAtSpan');
    createdAtSpan.textContent = `업로드 일시: ${created_at}`;

    infoDiv.appendChild(starScoreSpan)
    infoDiv.appendChild(makerNameSpan)
    infoDiv.appendChild(createdAtSpan)

    // # 2-1 ==============게임 상세 span2===================
    const infoDiv2 = document.getElementById('infoDiv2')

    const tagSpan = document.createElement('span');
    tagSpan.textContent = '태그: ';

    tag.forEach((item, index) => {
      const tagItemSpan = document.createElement('span');
      if (index > 0) {
        tagItemSpan.textContent = `, ${item.name}`;
      } else {
        tagItemSpan.textContent = item.name;
      }
      tagSpan.appendChild(tagItemSpan);
    })

    infoDiv2.appendChild(tagSpan)

    // # 3 ==================video와 screenshot=====================
    // const containerDiv = document.createElement('div');
    // containerDiv.className = 'd-flex align-items-center justify-content-around'
    const containerDiv = document.getElementById('containerDiv');

    /*const videoIframeElement = document.createElement('iframe');
    videoIframeElement.width = '560';
    videoIframeElement.height = '315';
    videoIframeElement.src = 'https://www.youtube.com/embed/_2MtnLyBdbk';
    videoIframeElement.frameBorder = '0';
    videoIframeElement.allow = 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share';
    videoIframeElement.referrerPolicy = 'strict-origin-when-cross-origin';
    videoIframeElement.allowFullscreen = true;

    containerDiv.appendChild(videoIframeElement);

    for (let i = 0; i < screenshot.length; i++) {
      const imgElement = document.createElement('img');
      imgElement.src = screenshot[i].src;
      imgElement.alt = '';
      imgElement.style.width = '300px';
      containerDiv.appendChild(imgElement);
    }*/
    
    // document.body.appendChild(containerDiv);

    // #4 ====================작성자의 게임 설명===========================
    // const contentDiv = document.createElement('div');
    // contentDiv.textContent = `content: ${content}`;
    // document.body.appendChild(contentDiv);
    const contentDiv = document.getElementById('contentDiv');

    // # 5==================댓글 작성 form, 수정 필요======================
    /* const formElement = document.createElement('form');
    formElement.action = ''
    formElement.method = 'POST';
    formElement.className = 'd-flex';

    const csrfTokenInput = document.createElement('input');
    csrfTokenInput.type = 'hidden';
    csrfTokenInput.name = 'csrfmiddlewaretoken';
    csrfTokenInput.value = '{{ csrf_token }}';

    const labelElement = document.createElement('label');
    labelElement.htmlFor = 'comment';
    labelElement.textContent = '댓글';

    const inputElement = document.createElement('input');
    inputElement.type = 'text';
    inputElement.name = 'comment';
    inputElement.id = 'comment';

    const buttonElement = document.createElement('button');
    buttonElement.type = 'submit';
    buttonElement.textContent = '게시';

    formElement.appendChild(csrfTokenInput);
    formElement.appendChild(labelElement);
    formElement.appendChild(inputElement);
    formElement.appendChild(buttonElement);

    document.body.appendChild(formElement);*/

    // # 6 =====================게시글에 달린 댓글========================
    // const commentContainerDiv = document.createElement('div');
    const commentContainerDiv = document.getElementById('commentContainerDiv');
// 
    comment_response.forEach(comment => {
      const commentDiv = document.createElement('div');

      const commentImgElement = document.createElement('img');
      if (comment.src) {
        commentImgElement.src = comment.src;
      } else {
        commentImgElement.src = '{% static 'image/user.png' %}'
        commentImgElement.style.width = '30px';
      }
      commentImgElement.alt = '';
      commentDiv.appendChild(commentImgElement);

      const authorSpanElement = document.createElement('span');
      authorSpanElement.textContent = `작성자: ${comment.author}`;
      commentDiv.appendChild(authorSpanElement);

      const contentSpanElement = document.createElement('span');
      contentSpanElement.textContent = `댓글 내용: ${comment.content}`;
      commentDiv.appendChild(contentSpanElement);

      const commendCreatedAtSpan = document.createElement('span');
      commendCreatedAtSpan.textContent = `작성 일시: ${comment.created_at}`;
      commentDiv.appendChild(commendCreatedAtSpan);

      const commentLineBreak = document.createElement('br');
      commentDiv.appendChild(commentLineBreak);

      commentContainerDiv.appendChild(commentDiv)
      // document.body.appendChild(commentContainerDiv)
    })
  });
  

</script>
{% endblock content %}
