{% extends "base.html" %} {% block content %} {% load static %}
{% comment %} action={% url 'games:CommentAPIView' game_pk %} {% endcomment %}

<form action='' method="POST" class="d=flex ">
  {% csrf_token %} 
  <label for="comment">댓글</label>
  <input type="text" name="comment" id="comment">
  <button type="submit">게시</button>
</form>

<script>
  window.addEventListener("load", async function PageLoad() {

    // context로 views.py에서 game_pk를 받아서 사용한다.
    const game_detail_URL = '{% url 'games:game_detail' game_pk %}';
    const comment_URL = '{% url 'games:comments' game_pk %}';

    const game_detail_response = await aSend({
      url: game_detail_URL,
      method: 'GET',
      is_token: false,
    });
    
    const comment_response = await aSend({
      url: comment_URL,
      method: 'GET',
      is_token: false,
    });

    const title = game_detail_response.title;
    const gamepath = game_detail_response.gamepath;
    const star_score = game_detail_response.star_score;
    const maker_name = game_detail_response.maker_name;
    const created_at = game_detail_response.created_at;
    const tag = game_detail_response.tag;
    const screenshot = game_detail_response.screenshot;
    const content = game_detail_response.content;
    
    // title과 iframe
    const titleContainer = document.createElement('div');
    titleContainer.className = 'd-flex flex-column align-items-center';

    const divElement = document.createElement('div');
    divElement.style.position = 'relative';
    divElement.style.width = '53%';
    divElement.style.paddingBottom = '36%';

    const titleElement = document.createElement('h1');
    titleElement.textContent = title;
    
    const iframeElement = document.createElement('iframe');
    iframeElement.style.cssText = 'position: absolute; width: 100%; height: 100%;'
    iframeElement.src = `${gamepath}/index.html`;
    
    document.body.appendChild(titleContainer);

    titleContainer.appendChild(titleElement);
    titleContainer.appendChild(divElement);
    divElement.appendChild(iframeElement);

    // 게임 상세 span
    const infoDiv = document.createElement('div');

    const starScoreSpan = document.createElement('span');
    starScoreSpan.textContent = `평점: ${star_score}`;

    const makerNameSpan = document.createElement('span');
    makerNameSpan.textContent = `제작자: ${maker_name}`;

    const createdAtSpan = document.createElement('span');
    createdAtSpan.textContent = `업로드 일시: ${created_at}`;

    const lineBreak = document.createElement('br');

    const tagSpan = document.createElement('span');
    tagSpan.textContent = '태그: ';

    tag.forEach((item, index) => {
      const tagItemSpan = document.createElement('span');
      if (index > 0) {
        tagItemSpan.textContent = `, ${item.name}`;
      } else {
        tagItemSpan.textContent = item.name;
      }
      tagSpan.appendChild(tagItemSpan);
    })


    document.body.appendChild(infoDiv)

    infoDiv.appendChild(starScoreSpan)
    infoDiv.appendChild(makerNameSpan)
    infoDiv.appendChild(createdAtSpan)
    infoDiv.appendChild(lineBreak)
    infoDiv.appendChild(tagSpan)

    // video와 screenshot
    const containerDiv = document.createElement('div');
    containerDiv.className = 'd-flex align-items-center justify-content-around'

    const videoIframeElement = document.createElement('iframe');
    videoIframeElement.width = '560';
    videoIframeElement.height = '315';
    videoIframeElement.src = 'https://www.youtube.com/embed/_2MtnLyBdbk';
    videoIframeElement.frameBorder = '0';
    videoIframeElement.allow = 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share';
    videoIframeElement.referrerPolicy = 'strict-origin-when-cross-origin';
    videoIframeElement.allowFullscreen = true;

    containerDiv.appendChild(videoIframeElement);

    for (let i = 0; i < screenshot.length; i++) {
      const imgElement = document.createElement('img');
      imgElement.src = screenshot[i].src;
      imgElement.alt = '';
      imgElement.style.width = '300px';
      containerDiv.appendChild(imgElement);
    }
    
    document.body.appendChild(containerDiv);

    // 작성자의 게임 설명
    const contentDiv = document.createElement('div');
    contentDiv.textContent = `content: ${content}`;
    document.body.appendChild(contentDiv);

    // 댓글 작성 form, 수정 필요
    const formElement = document.createElement('form');
    formElement.action = '';
    formElement.method = 'POST';
    formElement.className = 'd-flex';

    const csrfTokenInput = document.createElement('input');
    csrfTokenInput.type = 'hidden';
    csrfTokenInput.name = 'csrfmiddlewaretoken';
    csrfTokenInput.value = '{{ csrf_token }}';

    const labelElement = document.createElement('label');
    labelElement.htmlFor = 'comment';
    labelElement.textContent = '댓글';

    const inputElement = document.createElement('input');
    inputElement.type = 'text';
    inputElement.name = 'comment';
    inputElement.id = 'comment';

    const buttonElement = document.createElement('button');
    buttonElement.type = 'submit';
    buttonElement.textContent = '게시';

    formElement.appendChild(csrfTokenInput);
    formElement.appendChild(labelElement);
    formElement.appendChild(inputElement);
    formElement.appendChild(buttonElement);

    document.body.appendChild(formElement);

    // 게시글에 달린 댓글
    const commentContainerDiv = document.createElement('div');

    comment_response.forEach(comment => {
      const commentDiv = document.createElement('div');

      const commentImgElement = document.createElement('img');
      if (comment.src) {
        commentImgElement.src = comment.src;
      } else {
        commentImgElement.src = '{% static 'image/user.png' %}'
        commentImgElement.style.width = '30px';
      }
      commentImgElement.alt = '';
      commentDiv.appendChild(commentImgElement);

      const authorSpanElement = document.createElement('span');
      authorSpanElement.textContent = `작성자: ${comment.author}`;
      commentDiv.appendChild(authorSpanElement);

      const contentSpanElement = document.createElement('span');
      contentSpanElement.textContent = `댓글 내용: ${comment.content}`;
      commentDiv.appendChild(contentSpanElement);

      const commendCreatedAtSpan = document.createElement('span');
      commendCreatedAtSpan.textContent = `작성 일시: ${comment.created_at}`;
      commentDiv.appendChild(commendCreatedAtSpan);

      const commentLineBreak = document.createElement('br');
      commentDiv.appendChild(commentLineBreak);

      commentContainerDiv.appendChild(commentDiv)
      document.body.appendChild(commentContainerDiv)
    })
  });
  

</script>
{% endblock content %}
