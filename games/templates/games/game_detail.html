{% extends "base.html" %} 
{% load static %}

{% block css_block %}
  <link rel="stylesheet" href="{% static 'css/star.css' %}">
  <link rel="stylesheet" href="{% static 'css/scroll.css' %}">
{% endblock css_block %}

{% block content %}
<div id='titleContainer' class="d-flex flex-column align-items-center"></div>
<hr>
    <div class="container">
        <div class='d-flex justify-content-between' style='width:100%;'>
            <div class='d-flex justify-content-around' style='width:50%;'>
                <div id='infoDiv' class='d-flex flex-column'>
                    <span id='starScoreSpan'></span>
                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#exampleModal">★★★★★</button>
                </div>
                <div id='infoDiv2' class='d-flex flex-column'>
                    <a id='makerProfile' style='text-decoration: none; color:inherit;'>
                      <span id='makerNameSpan'></span>
                    </a>
                    <span>해당 게임 :</span><button id='gameLikeBtn' onclick='like();'>즐겨찾기</button>
                </div>
                <div id='infoDiv3' class='d-flex flex-column'>
                    <span id='createdAtSpan'></span>
                </div>
            </div>
            <div id="editDeleteBtn" class="d-flex"></div>
        </div>
    </div>
    <div class="container">
        <div id='containerDiv' class='d-flex flex-column align-items-center justify-content-center'></div>
        <div id='contentDiv' class='mt-3 mb-3 px-3 py-3 border border-info rounded'>
            <p>게임 설명: </p>
        </div>
    </div>
    <hr>
    <div class="container">
        <div>
            <form id='formElement' method='POST' onsubmit="commentCreate(event);">
                {% csrf_token %}
                <label for="comment">댓글</label>
                <input type="text" id='comment' name='content'>
                <button id="comment_id" type="submit">제출</button>
            </form>
            <hr>
            <div id='commentContainerDiv'></div>
        </div>
    </div>
<!-- Modal -->
<div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="exampleModalLabel">별점 선택창</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id='login_modal_body' style='display:none;'>
          <span>별점을 선택해주세요</span>
          <form name="myform" id="myform" method="POST">
            <fieldset class='d-flex justify-content-center'>
                <input type="radio" name="star" value="5" id="rate1"><label for="rate1">⭐</label>
                <input type="radio" name="star" value="4" id="rate2"><label for="rate2">⭐</label>
                <input type="radio" name="star" value="3" id="rate3"><label for="rate3">⭐</label>
                <input type="radio" name="star" value="2" id="rate4"><label for="rate4">⭐</label>
                <input type="radio" name="star" value="1" id="rate5"><label for="rate5">⭐</label>
            </fieldset>
        </form>
        </div>
        <div id='logout_modal_body' style='display:none;'>
          <span>로그인 해주세요</span>
        </div>
      </div>
      <div id='login_modal_footer' style='display:none; justify-content:end;' class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">나가기</button>
        <button type="submit" class="btn btn-primary" onclick='star(event);'>확인</button>
      </div>
      <div id='logout_modal_footer' style='display:none;' class="modal-footer">
        <a class="btn btn-primary" href='{% url 'accounts:login_page' %}'>로그인페이지로 이동</a>
      </div>
    </div>
  </div>
</div>

<script>
  function resizeIframe(event) {
      if (event.data.width && event.data.height) {
          var iframe = document.getElementById('gameIframe');
          iframe.style.width = event.data.width + 'px';
          iframe.style.height = event.data.height + 'px';
      }
  }

  window.addEventListener('message', resizeIframe);
</script>

<script>
  function getGameId(){
    const path=window.location.pathname;
    const parts =path.split('/');
    return parseInt(parts[3]);
  }

  function addCommentToDOM(comment, user) {
    const comment_container_div = document.getElementById('commentContainerDiv');
    const contain_div = document.createElement('div');

    const comment_div = document.createElement('div');
    comment_div.setAttribute('data-comment-id', comment.id)
    comment_div.setAttribute("class", "d-flex justify-content-between");
    contain_div.appendChild(comment_div)

    const profilewidth = 10;

    const user_div = document.createElement('div');
    user_div.setAttribute("class", "d-flex align-items-center");
    user_div.setAttribute("style", `width:${profilewidth}%`);

    const profile_div = document.createElement('a');
    let url_author = "{% url 'users:profile_page' 1 %}".replace('1', comment.author);
    profile_div.setAttribute("href", url_author);
    profile_div.setAttribute("style", "text-decoration:none;");
    profile_div.setAttribute("class", "text-dark");

    const subject_div = document.createElement('div');
    subject_div.setAttribute("class", "btn d-flex align-items-center justify-content-between");
    subject_div.setAttribute("style", `width:${100-profilewidth}%`);

    const content_div = document.createElement('div');
    const date_div = document.createElement('div');

    comment_div.appendChild(user_div);
    comment_div.appendChild(subject_div);
    user_div.appendChild(profile_div);
    subject_div.appendChild(content_div);
    subject_div.appendChild(date_div);

    const comment_img_element = document.createElement('img');
    if (comment.src) {
      comment_img_element.src = comment.src;
    }
    else {
      comment_img_element.src = '{% static 'image/user.png' %}';
    }
    comment_img_element.style.width = '30px';
    comment_img_element.alt = '';
    comment_img_element.setAttribute("class", "me-1");
    profile_div.appendChild(comment_img_element);

    const author_span_element = document.createElement('span');
    let a_name = comment.author_name;
    console.log(a_name);
    if (a_name.length > 8){
      a_name = a_name.substring(0,8)+"...";
    }
    author_span_element.textContent = `${a_name}`;
    profile_div.appendChild(author_span_element);

    const content_span_element = document.createElement('span');
    content_span_element.textContent = `${comment.content}`;
    content_span_element.setAttribute('class', 'editable-comment-content');
    content_div.appendChild(content_span_element);

    const commend_created_at_span = document.createElement('span');
    commend_created_at_span.textContent = `${formatTime(comment.created_at)}`;
    date_div.appendChild(commend_created_at_span);

    const comment_edit_delete_div = document.createElement('div');
    comment_div.appendChild(comment_edit_delete_div);
    const comment_edit_btn = document.createElement('i');
    const comment_delete_btn = document.createElement('i');
    if (comment.is_visible){
      if (user) {
          if (user.user_pk === comment.author || user.is_staff == true) {

              comment_edit_btn.setAttribute('id', "commentEditBtn");
              comment_delete_btn.setAttribute('id', "commentDeleteBtn");

              comment_edit_btn.setAttribute('onclick', `commentEdit('${comment.id}','${comment.content}');`);
              comment_delete_btn.setAttribute('onclick', `commentDelete('${comment.id}');`);

              comment_edit_btn.setAttribute('class', "bi bi-pencil-square btn");
              comment_delete_btn.setAttribute('class', "bi bi-x-square btn");

              comment_edit_btn.setAttribute('style', "padding:0; outline:none; border:none;");
              comment_delete_btn.setAttribute('style', "padding:0; outline:none; border:none;");

              comment_edit_delete_div.appendChild(comment_edit_btn);
              comment_edit_delete_div.appendChild(comment_delete_btn);
          }
      }
    }

    subject_div.onclick = function(){
      if(comment.is_visible){
        let exist_reply_form = contain_div.querySelector('.replyForm');
        if(exist_reply_form) {
          exist_reply_form.remove();
        }
        else {
            const reply_form = document.createElement('form');
            reply_form.className = 'replyForm mt-3';
            reply_form.onsubmit = function(e){replyCreate(e,comment.id);};

            const reply_input = document.createElement('input');
            reply_input.type = 'text';
            reply_input.name = 'content';
            reply_input.placeholder = '답글을 입력하세요';
            reply_input.setAttribute("class", "me-2")

            const reply_submit_button = document.createElement('button');
            reply_submit_button.type = 'submit';
            reply_submit_button.setAttribute("id", "reply_id")
            reply_submit_button.textContent = '댓글 달기';

            reply_form.appendChild(reply_input);
            reply_form.appendChild(reply_submit_button);

            contain_div.appendChild(reply_form);
        }
      }
    };

    comment_container_div.appendChild(contain_div);
    const comment_line_break = document.createElement('hr');
    comment_container_div.appendChild(comment_line_break);
}

  async function commentCreate(event) {
    event.preventDefault();  // 폼의 기본 제출 동작을 방지
    const user = await isLogIn();
    if(!user){
      setModal("comment_id")
      return
    }

    const form_tag = document.getElementById('formElement');
    const form_data = new FormData(form_tag);

    const url = '{% url 'games:comments' game_pk %}'

    try {
        const res=await aSend({
            url: url,
            method: 'POST',
            is_token: true,
            body: form_data
        })
        
        // 새로운 댓글 DOM에 추가
        const new_comment = await res;
        addCommentToDOM(new_comment, user);

        // 입력 필드 초기화
        form_tag.reset();
    } catch (error) {
        console.error('Error:', error);
        return false;
    }
}

function addReplyToDOM(reply, user, root_id) {
  const comment_div = document.querySelector(`div[data-comment-id="${root_id}"]`);
  const parent_div=comment_div.parentNode;
  const reply_container = comment_div.querySelector('.replies') || document.createElement('div');
  reply_container.classList.add('replies');

  const reply_div = document.createElement('div');
  reply_div.setAttribute('data-comment-id', reply.id)
  reply_div.setAttribute("class", "comment d-flex justify-content-between mt-3");

  const reply_arrow_div = document.createElement('div');
  reply_arrow_div.setAttribute("class", "d-flex align-items-center");
  reply_arrow_div.setAttribute("style", "width:2.5%");

  const reply_user_div = document.createElement('div');
  reply_user_div.setAttribute("class", "d-flex align-items-center");
  reply_user_div.setAttribute("style", "width:10%");

  const reply_subject_div = document.createElement('div');
  reply_subject_div.setAttribute("class", "d-flex align-items-center justify-content-between");
  reply_subject_div.setAttribute("style", "width:87.5%");

  const reply_profile_div = document.createElement('a');
  let url_reply_author = "{% url 'users:profile_page' 1 %}".replace('1', reply.author);
  reply_profile_div.setAttribute("href", url_reply_author);
  reply_profile_div.setAttribute("style", "text-decoration:none;");
  reply_profile_div.setAttribute("class", "text-dark");

  const reply_content_div = document.createElement('div');
  const replydateDiv = document.createElement('div');

  reply_div.appendChild(reply_arrow_div);
  reply_div.appendChild(reply_user_div);
  reply_div.appendChild(reply_subject_div);
  reply_user_div.appendChild(reply_profile_div);
  reply_subject_div.appendChild(reply_content_div);
  reply_subject_div.appendChild(replydateDiv);

  const indent_symbol = document.createElement('span');
  indent_symbol.textContent = '↳';
  indent_symbol.style.marginLeft = '10px';
  indent_symbol.style.marginRight = '10px';
  reply_arrow_div.appendChild(indent_symbol);

  const reply_img_element = document.createElement('img');
  if (reply.src) {
    reply_img_element.src = reply.src;
  } else {
    reply_img_element.src = '{% static 'image/user.png' %}';
  }
  reply_img_element.style.width = '30px';
  reply_img_element.alt = '';
  reply_img_element.setAttribute("class", "me-1");
  reply_profile_div.appendChild(reply_img_element);

  const reply_author_span_element = document.createElement('span');
  let reply_a_name = reply.author_name;
  if (reply_a_name.length > 8){
    reply_a_name = reply_a_name.substring(0,8)+"...";
  }
  reply_author_span_element.textContent = `${reply_a_name}`;
  reply_profile_div.appendChild(reply_author_span_element);

  const reply_content_span_element = document.createElement('span');
  reply_content_span_element.textContent = `${reply.content}`;
  reply_content_span_element.setAttribute('class', 'editable-comment-content');
  reply_content_div.appendChild(reply_content_span_element);

  const reply_created_at_span = document.createElement('span');
  reply_created_at_span.textContent = `${formatTime(reply.created_at)}`;
  reply_created_at_span.style.marginRight = '13px';
  replydateDiv.appendChild(reply_created_at_span);
  
  const reply_edit_delete_div = document.createElement('div');
  reply_div.appendChild(reply_edit_delete_div)
  const reply_edit_btn = document.createElement('i');
  const reply_delete_btn = document.createElement('i');
  
  if(reply.is_visible){
    if (user) {
        if (user.user_pk === reply.author || user.is_staff==true) {

            reply_edit_btn.setAttribute('id', "replyEditBtn");
            reply_delete_btn.setAttribute('id', "replyDeleteBtn");

            reply_edit_btn.setAttribute('onclick', `commentEdit('${reply.id}');`);
            reply_delete_btn.setAttribute('onclick', `commentDelete('${reply.id}');`);

            reply_edit_btn.setAttribute('class', "bi bi-pencil-square btn");
            reply_delete_btn.setAttribute('class', "bi bi-x-square btn");

            reply_edit_btn.setAttribute('style', "padding:0; outline:none; border:none;");
            reply_delete_btn.setAttribute('style', "padding:0; outline:none; border:none;");

            reply_edit_delete_div.appendChild(reply_edit_btn);
            reply_edit_delete_div.appendChild(reply_delete_btn);
        }
    }
  }

  reply_container.appendChild(reply_div);

  if (!comment_div.querySelector('.replies')) {
    parent_div.appendChild(reply_container);
  }
  comment_div.childNodes[1].click()
  comment_div.childNodes[1].click()
}

async function replyCreate(event, root_id) {
  event.preventDefault();  // 폼의 기본 제출 동작을 방지
  const user = await isLogIn();
  if(!user){
    setModal("reply_id")
    return
  }

  const reply_form=event.target;
  const form_data = new FormData(reply_form);
  form_data.append('root', root_id);
  const content = form_data.get('content');
  if (!content) {
      alert("댓글 내용을 입력하세요.");
      return;
  }
  const url = '{% url 'games:comments' game_pk %}'

  try {
      const res=await aSend({
          url: url,
          method: 'POST',
          is_token: true,
          body: form_data
      })

      // 새로운 댓글 DOM에 추가
      const new_reply = await res;
      addReplyToDOM(new_reply, user, root_id);

      reply_form.reset();
  } catch (error) {
      console.error('Error:', error);
      return false;
  }
}

function updateStarRating(newRating) {
  const starScoreSpan = document.getElementById('starScoreSpan');
  if (newRating == null) {
    starScoreSpan.textContent = `평점: 평점없음`;
  } else {
    starScoreSpan.textContent = `평점: ${newRating}`;
  }
}

async function star(event) {
  event.preventDefault();  // 폼의 기본 제출 동작을 방지

  const form_tag = document.getElementById('myform');
  const form_data = new FormData(form_tag);

  const url = '{% url 'games:game_star' game_pk %}'

  try {
      let res = await aSend({
          url: url,
          method: 'POST',
          is_token: true,
          body: form_data
      })
      updateStarRating(res.avg_star);
      const modal = bootstrap.Modal.getInstance(document.getElementById('exampleModal'));
      if (modal) {
        modal.hide();
      }
  } catch (error) {
      console.error('Error:', error);
      return false;
  }
}

async function like() {
  const game_like_btn = document.getElementById('gameLikeBtn')
  const game_pk = getGameId();
  const url = '{% url 'games:game_like' 1 %}'.replace('1', game_pk)
  const access = localStorage.getItem('access_token')

  const response = await fetch(url, {
    method: 'POST',
    headers: {
        'X-CSRFToken': '{{ csrf_token }}',
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${access}`
    },
  })

  const data = await response.json()
  if (data.message === '즐겨찾기') {
    game_like_btn.innerText = '즐겨찾기 취소'
  } else {
    game_like_btn.innerText = '즐겨찾기'
  }
}

  function gameEdit() {
      const game_pk = getGameId();
      window.location.href = "{% url 'games:game_update_page' 1 %}".replace('1', game_pk);
  }
  
  async function gameDelete() {
      const game_pk = getGameId();
      
      const url = '{% url 'games:game_detail' 1 %}'.replace('1', game_pk);
      const access = localStorage.getItem('access_token');

      const resp = await fetch(url, {
          method: 'DELETE',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${access}`
          },
      });
      
      if (resp.status >= 200 && resp.status < 300) {
          window.location.href = "{% url 'main_view' %}"
      }
  }

  window.addEventListener("load", async function pageLoad() {

    // context로 views.py에서 game_pk를 받아서 사용한다.
    const game_detail_url = '{% url 'games:game_detail' game_pk %}';
    const comment_url = '{% url 'games:comments' game_pk %}';

    const game_detail_response = await aSend({
      url: game_detail_url,
      method: 'GET',
      is_token: false,
    });
    
    const comment_response = await aSend({
      url: comment_url,
      method: 'GET',
      is_token: false,
    });

    const title = game_detail_response.title;
    const gamepath = game_detail_response.gamepath;
    const star_score = game_detail_response.star_score;
    const maker_name = game_detail_response.maker_name;
    const created_at = game_detail_response.created_at;
    const tag = game_detail_response.tag;
    const screenshot = game_detail_response.screenshot;
    const content = game_detail_response.content;
    const youtube_url = game_detail_response.youtube_url;
    const maker = game_detail_response.maker;
    // # 1 ==============title과 iframe=====================
    // const titleContainer = document.createElement('div');
    // titleContainer.className = 'd-flex flex-column align-items-center';
    const titleContainer = document.getElementById('titleContainer');

    // # 1 ==============title과 iframe=====================
    const title_container = document.getElementById('titleContainer');

    const title_element = document.createElement('h1');
    title_element.textContent = title;
    title_container.appendChild(title_element);
    
    if (game_detail_response.register_state === 1) {
        const div_element = document.createElement('div');
        div_element.style.cssText = 'overflow:hidden;';
        div_element.className = 'h-100';
        const iframe_element = document.createElement('iframe');
        iframe_element.setAttribute("id","gameIframe");
        iframe_element.style.cssText = 'border:none; width:10%; height:100%;';
        iframe_element.src = `${gamepath}/index.html`;
        
        div_element.appendChild(iframe_element);
        title_container.appendChild(div_element);
    } else {
        const div_element = document.createElement('div');
        div_element.style.position = 'relative';
        div_element.style.width = '78%';
        div_element.style.paddingTop = '19%';
        div_element.style.paddingBottom = '19%';
        div_element.style.backgroundColor = "gray";
        div_element.style.textAlign = "center";
        div_element.style.alignSelf = "center";
        
        const span_element = document.createElement("span");
        span_element.innerText = "서비스 준비 중입니다."
        span_element.style.fontSize = "50px";
        
        div_element.appendChild(span_element);
        title_container.appendChild(div_element);
    }

    // # 2 ================게임 상세 span==================
    const info_div = document.getElementById('infoDiv');

    const star_score_span = document.getElementById('starScoreSpan');
    if (star_score == null) {
      star_score_span.textContent = `평점: 평점없음`;
    }
    else{
      star_score_span.textContent = `평점: ${star_score}`;
    }
    const maker_profile = document.getElementById('makerProfile');
    const maker_profile_url = '{% url 'users:profile_page' 1 %}'.replace('1', maker);
    maker_profile.setAttribute('href', maker_profile_url);
    const makerNameSpan = document.getElementById('makerNameSpan');
    makerNameSpan.textContent = `제작자: ${maker_name}`;

    const created_at_span = document.getElementById('createdAtSpan');
    created_at_span.textContent = `업로드 일시: ${formatTime(created_at)}`;

    // # 2-1 ============== 게임 상세 span - star ================
    const login_modal_body = document.getElementById('login_modal_body');
    const logout_modal_body = document.getElementById('logout_modal_body');
    const login_modal_footer = document.getElementById('login_modal_footer');
    const logout_modal_footer = document.getElementById('logout_modal_footer');

    const user = await isLogIn();
    if (user) {
      login_modal_body.style.display = 'block';
      login_modal_footer.style = 'display: flex; justify-content-end;';
    } else {
      logout_modal_body.style.display = 'block';
      logout_modal_footer.style = 'display: flex; justify-content-end;';
    }
    // # 2-2 ================= 게임 상세 span - like ==============
    const game_like_btn = document.getElementById('gameLikeBtn');
    if (user) {
        for (let item of game_detail_response.like) {
            if (item === user.user_pk) {
              game_like_btn.innerText = '즐겨찾기 취소'
            } 
        }
    } else {
        // 로그아웃 상태일 경우 즐겨찾기 버튼 클릭 시 로그인 해주세요 모달창 띄우도록 설정
        setModal("gameLikeBtn");
    }

    // # 2-3 ============== 게임 상세 span - tag ===================
    const info_div3 = document.getElementById('infoDiv3')

    const tag_span = document.createElement('span');
    tag_span.textContent = '태그: ';

    tag.forEach((item, index) => {
      const tag_item_span = document.createElement('span');
      if (index > 0) {
        tag_item_span.textContent = `, ${item.name}`;
      } else {
        tag_item_span.textContent = item.name;
      }
      tag_span.appendChild(tag_item_span);
    })

    info_div3.appendChild(tag_span)
      
      // # 3 ============== 게임 상세 - 수정 / 삭제 버튼 ===================
      const game_edit_btn = document.createElement('button');
      const game_delete_btn = document.createElement('button');
      
      if (user) {
          if (user.user_pk === game_detail_response.maker || user.is_staff==true) {
              const editDeleteBtn = document.getElementById("editDeleteBtn");
              
              game_edit_btn.setAttribute('id', "gameEditBtn");
              game_delete_btn.setAttribute('id', "gameDeleteBtn");
              
              game_edit_btn.setAttribute('class', "mt-3 mb-3 me-2 btn btn btn-info");
              game_delete_btn.setAttribute('class', "mt-3 mb-3 me-2 btn btn-danger");
              
              game_edit_btn.setAttribute('onclick', "gameEdit();");
              game_delete_btn.setAttribute('onclick', "gameDelete();");
              
              game_edit_btn.innerText = "수정"
              game_delete_btn.innerText = "삭제"
              
              editDeleteBtn.appendChild(game_edit_btn);
              editDeleteBtn.appendChild(game_delete_btn);
          }
      }
      
      
    const container_div = document.getElementById('containerDiv');
    if (youtube_url || screenshot.length > 0) {
      container_div.innerHTML =`\
      <div id='wrap-vertical' class="scroll-container"></div>\
      <br>\
      <div id="carouselExampleIndicators" class="carousel slide">\
          <div id='carouselContent' class="carousel-inner" style="position: relative; width: 960px; padding-bottom: 56.25%;"></div>\
      </div>`
    } 
    // # 4 ================== video와 screenshot ====================
    const carousel_button_div = document.getElementById('wrap-vertical');
    const carousel_content_div = document.getElementById('carouselContent');
    let content_idx = 0
    
    if (youtube_url) {
      const youtube_button = document.createElement('button')
      youtube_button.setAttribute('type','button')
      youtube_button.setAttribute('data-bs-target','#carouselExampleIndicators')
      youtube_button.setAttribute('data-bs-slide-to',`${content_idx}`)
      youtube_button.setAttribute('class','active')
      youtube_button.setAttribute('aria-current','true')
      youtube_button.setAttribute('aria-label',`Slide ${content_idx + 1}`)
      youtube_button.setAttribute('style','vertical-align:middle; width:300px; height:150px;')

      const youtube_thumbnail = document.createElement('img')
      const youtube_id = youtube_url.split('/')[3].replace('watch?v=','').split('?')[0].split('&')[0]
      const youtube_thumbnail_src = 'https://img.youtube.com/vi/' + youtube_id + '/0.jpg'
      youtube_thumbnail.setAttribute('src', youtube_thumbnail_src)
      youtube_thumbnail.setAttribute('class','d-block w-100')
      youtube_thumbnail.setAttribute('alt','...')

      youtube_button.appendChild(youtube_thumbnail)
      carousel_button_div.appendChild(youtube_button)

      const youtube_div = document.createElement('div')
      youtube_div.setAttribute('class','carousel-item active')
      youtube_div.setAttribute('style','position: absolute; max-width: 100%; height: 100%')

      const youtube_iframe = document.createElement('iframe')
      const youtube_src = 'https://www.youtube.com/embed/' + youtube_id
      youtube_iframe.setAttribute('style','position: absolute; width: 100%; height: 100%')
      youtube_iframe.setAttribute('src',youtube_src)
      youtube_iframe.setAttribute('title','YouTube video player')
      youtube_iframe.setAttribute('frameborder','0')
      youtube_iframe.setAttribute('allow','accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share')
      youtube_iframe.setAttribute('referrerpolicy','strict-origin-when-cross-origin')
      youtube_iframe.setAttribute('allowfullscreen','true')

      youtube_div.appendChild(youtube_iframe)
      carousel_content_div.appendChild(youtube_div)
      content_idx += 1
    }

    for (item of screenshot) {
      const screenshot_button = document.createElement('button')
      if (content_idx == 0) {
        screenshot_button.setAttribute('class','active')
        screenshot_button.setAttribute('aria-current','true')
      }
      screenshot_button.setAttribute('type','button')
      screenshot_button.setAttribute('data-bs-target','#carouselExampleIndicators')
      screenshot_button.setAttribute('data-bs-slide-to',`${content_idx}`)
      screenshot_button.setAttribute('aria-label',`Slide ${content_idx + 1}`)
      screenshot_button.setAttribute('style',"vertical-align:middle; width:300px; height:150px;")

      const screenshot_button_img = document.createElement('img')
      screenshot_button_img.setAttribute('src',item.src)
      screenshot_button_img.setAttribute('class','d-block w-100')
      screenshot_button_img.setAttribute('alt','...')

      screenshot_button_img.setAttribute('style','object-fit: contain; object-position: center; width: 100%; height: 100%;')

      screenshot_button.appendChild(screenshot_button_img)
      carousel_button_div.appendChild(screenshot_button)

      const screenshot_div = document.createElement('div')
      if (content_idx == 0) {
        screenshot_div.setAttribute('class','carousel-item active')
      } else {
        screenshot_div.setAttribute('class','carousel-item')
      }
      screenshot_div.setAttribute('style','position: absolute; width: 100%; height: 100%;')

      const screenshot_img = document.createElement('img')
      screenshot_img.setAttribute('style','object-fit: contain; object-position: center center; max-width: 100%; max-height: 100%; position: absolute;')
      screenshot_img.setAttribute('src',item.src)
      screenshot_img.setAttribute('class','d-block w-100 h-100')
      screenshot_img.setAttribute('alt','...')

      screenshot_div.appendChild(screenshot_img)
      carousel_content_div.appendChild(screenshot_div)
      content_idx += 1
    }
    // ===================== 텍스트 영역 (게임 설명) =====================
    const content_div = document.getElementById("contentDiv");
    const content_text = document.createElement("span");
    content_text.innerText = content;
    content_div.appendChild(content_text);

    // # 6 =====================게시글에 달린 댓글========================
    const comment_container_div = document.getElementById('commentContainerDiv');
    comment_response.forEach(comment => {
        const contain_div = document.createElement('div');

        const comment_div = document.createElement('div');
        comment_div.setAttribute('data-comment-id',comment.id)
        comment_div.setAttribute("class", "d-flex justify-content-between");
        contain_div.appendChild(comment_div)

        const profilewidth = 10;
        const replyarrowwidth = 2.5;

        const user_div = document.createElement('div');
        user_div.setAttribute("class", "d-flex align-items-center");
        user_div.setAttribute("style", `width:${profilewidth}%`);

        const profile_div = document.createElement('a');
        let url_author="{% url 'users:profile_page' 1 %}".replace('1',comment.author);
        profile_div.setAttribute("href", url_author);
        profile_div.setAttribute("style","text-decoration:none;");
        profile_div.setAttribute("class","text-dark");

        const subject_div = document.createElement('div');
        subject_div.setAttribute("class", "btn d-flex align-items-center justify-content-between");
        subject_div.setAttribute("style", `width:${100-profilewidth}%`);

        const content_div = document.createElement('div');
        const date_div = document.createElement('div');

        comment_div.appendChild(user_div);
        comment_div.appendChild(subject_div);
        user_div.appendChild(profile_div);
        subject_div.appendChild(content_div);
        subject_div.appendChild(date_div);

        const comment_img_element = document.createElement('img');
        if (comment.src) {
          comment_img_element.src = comment.src;
        }
        else {
          comment_img_element.src = '{% static 'image/user.png' %}';
        }
        comment_img_element.style.width = '30px';
        comment_img_element.alt = '';
        comment_img_element.setAttribute("class", "me-1");
        profile_div.appendChild(comment_img_element);

        const author_span_element = document.createElement('span');
        let a_name=comment.author_name;
        if (a_name.length > 8){
          a_name = a_name.substring(0,8)+"...";
        }
        author_span_element.textContent = `${a_name}`;
        profile_div.appendChild(author_span_element);

        const content_span_element = document.createElement('span');
        content_span_element.textContent = `${comment.content}`;
        content_span_element.setAttribute('class', 'editable-comment-content');
        content_div.appendChild(content_span_element);

        const commend_created_at_span = document.createElement('span');
        commend_created_at_span.textContent = `${formatTime(comment.created_at)}`;
        date_div.appendChild(commend_created_at_span);

        const comment_edit_delete_div= document.createElement('div');
        comment_div.appendChild(comment_edit_delete_div);
        const comment_edit_btn = document.createElement('i');
        const comment_delete_btn = document.createElement('i');
        if (comment.is_visible){
          if (user) {
              if (user.user_pk === comment.author || user.is_staff==true) {
                  
                  comment_edit_btn.setAttribute('id', "commentEditBtn");
                  comment_delete_btn.setAttribute('id', "commentDeleteBtn");
                  
                  comment_edit_btn.setAttribute('onclick', `commentEdit('${comment.id}','${comment.content}');`);
                  comment_delete_btn.setAttribute('onclick', `commentDelete('${comment.id}');`);
                  
                  comment_edit_btn.setAttribute('class', "bi bi-pencil-square btn");
                  comment_delete_btn.setAttribute('class', "bi bi-x-square btn");
                  
                  comment_edit_btn.setAttribute('style', "padding:0; outline:none; border:none;");
                  comment_delete_btn.setAttribute('style', "padding:0; outline:none; border:none;");
                  
                  comment_edit_delete_div.appendChild(comment_edit_btn);
                  comment_edit_delete_div.appendChild(comment_delete_btn);
              }
          }
        }

        subject_div.onclick=function(){
          if(comment.is_visible){
            let exist_reply_form=contain_div.querySelector('.replyForm');
            if(exist_reply_form) {
              exist_reply_form.remove();
            }
            else {
                const reply_form=document.createElement('form');
                reply_form.className = 'replyForm mt-3';
                reply_form.onsubmit=function(e){replyCreate(e,comment.id);};

                const reply_input=document.createElement('input');
                reply_input.type = 'text';
                reply_input.name = 'content';
                reply_input.placeholder = '답글을 입력하세요';
                reply_input.setAttribute("class", "me-2")

                const reply_submit_button = document.createElement('button');
                reply_submit_button.type = 'submit';
                reply_submit_button.setAttribute("id","reply_id")
                reply_submit_button.textContent = '댓글 달기';

                reply_form.appendChild(reply_input);
                reply_form.appendChild(reply_submit_button);

                contain_div.appendChild(reply_form);
            }
          }
        };

        if (comment.replies && comment.replies.length > 0) {
            const reply_container = document.createElement('div');
            reply_container.classList.add('replies');
            comment.replies.forEach(reply => {
                const reply_div = document.createElement('div');
                reply_div.setAttribute('data-comment-id',reply.id)
                reply_div.setAttribute("class", "comment d-flex justify-content-between mt-3");

                const reply_arrow_div = document.createElement('div');
                reply_arrow_div.setAttribute("class", "d-flex align-items-center");
                reply_arrow_div.setAttribute("style", `width:${replyarrowwidth}%`);

                const reply_user_div = document.createElement('div');
                reply_user_div.setAttribute("class", "d-flex align-items-center");
                reply_user_div.setAttribute("style", `width:${profilewidth}%`);

                const reply_subject_div = document.createElement('div');
                reply_subject_div.setAttribute("class", "d-flex align-items-center justify-content-between");
                reply_subject_div.setAttribute("style", `width:${100-profilewidth-replyarrowwidth}%`);

                const reply_profile_div = document.createElement('a');
                let url_reply_author="{% url 'users:profile_page' 1 %}".replace('1',reply.author);
                reply_profile_div.setAttribute("href", url_reply_author);
                reply_profile_div.setAttribute("style","text-decoration:none;");
                reply_profile_div.setAttribute("class","text-dark");

                const reply_content_div = document.createElement('div');
                const replydateDiv = document.createElement('div');

                reply_div.appendChild(reply_arrow_div);
                reply_div.appendChild(reply_user_div);
                reply_div.appendChild(reply_subject_div);
                reply_user_div.appendChild(reply_profile_div);
                reply_subject_div.appendChild(reply_content_div);
                reply_subject_div.appendChild(replydateDiv);

                const indent_symbol = document.createElement('span');
                indent_symbol.textContent = '↳'; // 원하는 기호로 변경 가능
                indent_symbol.style.marginLeft = '10px';
                indent_symbol.style.marginRight = '10px';
                reply_arrow_div.appendChild(indent_symbol);

                const reply_img_element = document.createElement('img');
                if (reply.src) {
                  reply_img_element.src = reply.src;
                } else {
                  reply_img_element.src = '{% static 'image/user.png' %}';
                }
                reply_img_element.style.width = '30px';
                reply_img_element.alt = '';
                reply_img_element.setAttribute("class", "me-1");
                reply_profile_div.appendChild(reply_img_element);

                const reply_author_span_element = document.createElement('span');
                let reply_a_name=reply.author_name;
                if (reply_a_name.length > 8){
                  reply_a_name = reply_a_name.substring(0,8)+"...";
                }
                reply_author_span_element.textContent = `${reply_a_name}`;
                reply_profile_div.appendChild(reply_author_span_element);

                const reply_content_span_element = document.createElement('span');
                reply_content_span_element.textContent = `${reply.content}`;
                reply_content_span_element.setAttribute('class', 'editable-comment-content');
                reply_content_div.appendChild(reply_content_span_element);

                const reply_created_at_span = document.createElement('span');
                reply_created_at_span.textContent = `${formatTime(reply.created_at)}`;
                reply_created_at_span.style.marginRight = '13px';
                replydateDiv.appendChild(reply_created_at_span);
                
                const reply_edit_delete_div= document.createElement('div');
                reply_div.appendChild(reply_edit_delete_div)
                const reply_edit_btn = document.createElement('i');
                const reply_delete_btn = document.createElement('i');
                
                if(reply.is_visible){
                  if (user) {
                      if (user.user_pk === reply.author || user.is_staff==true) {
                          
                          reply_edit_btn.setAttribute('id', "replyEditBtn");
                          reply_delete_btn.setAttribute('id', "replyDeleteBtn");
                          
                          reply_edit_btn.setAttribute('onclick', `commentEdit('${reply.id}');`);
                          reply_delete_btn.setAttribute('onclick', `commentDelete('${reply.id}');`);
                          
                          reply_edit_btn.setAttribute('class', "bi bi-pencil-square btn");
                          reply_delete_btn.setAttribute('class', "bi bi-x-square btn");
                  
                          reply_edit_btn.setAttribute('style', "padding:0; outline:none; border:none;");
                          reply_delete_btn.setAttribute('style', "padding:0; outline:none; border:none;");
                          
                          reply_edit_delete_div.appendChild(reply_edit_btn);
                          reply_edit_delete_div.appendChild(reply_delete_btn);
                      }
                  }
                }

                reply_container.appendChild(reply_div);
            });
            contain_div.appendChild(reply_container);
        }
        comment_container_div.appendChild(contain_div);
        const comment_line_break = document.createElement('hr');
        comment_container_div.appendChild(comment_line_break);
    });
  });

  async function commentDelete(commentId){
    const comment_url = '{% url 'games:comment_detail' 1 %}'.replace('1',commentId);
    const access=localStorage.getItem('access_token');

    try {
        const response = await fetch(comment_url, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${access}`,
                'X-CSRFToken': '{{ csrf_token }}'
            },
        });

        if (response.ok) {
          window.location.reload();
        } else {
            console.error('Failed to delete comment');
        }
    } catch (error) {
        console.error('Error:', error);
    }
  }

    async function commentEdit(commentId){
      const reply_content_spans = document.querySelector(`div[data-comment-id="${commentId}"] .editable-comment-content`);
      const new_content = prompt("수정할 댓글 내용:",reply_content_spans.textContent);
      if(new_content!==null&& new_content!==reply_content_spans.textContent){
        const reply_url = '{% url 'games:comment_detail' 1 %}'.replace('1',commentId);
        const access=localStorage.getItem('access_token');

        try {
          const response = await fetch(reply_url, {
              method: 'PUT',
              headers: {
                  'Content-Type': 'application/json',
                  'Authorization': `Bearer ${access}`,
                  'X-CSRFToken': '{{ csrf_token }}'
              },
              body: JSON.stringify({ content: new_content })
          });

          if (response.ok) {
            window.location.reload();
          } else {
              console.error('Failed to update comment');
          }
        } catch (error) {
          console.error('Error:', error);
        }
      }
    }
</script>
{% endblock content %}
